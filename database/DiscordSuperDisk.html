<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Super Disk | Production Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;700&display=swap');
        body { background: #0b0b0e; color: #e2e8f0; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; margin: 0; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        .scroll-area { 
            height: calc(100vh - 460px); 
            min-height: 280px;
            overflow-y: auto; 
            scrollbar-width: thin;
        }
        .scroll-area::-webkit-scrollbar { width: 4px; }
        .scroll-area::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .ssd-node { border: 1px solid #1e293b; background: rgba(15, 23, 42, 0.8); transition: all 0.2s; position: relative; }
        .ssd-node.corrupted { border: 2px solid #ef4444; background: rgba(127, 29, 29, 0.3); }
        .raid-tag { position: absolute; top: 8px; right: 8px; font-size: 8px; font-weight: bold; color: #475569; }
        .packet { position: absolute; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-family: 'JetBrains Mono'; z-index: 999; pointer-events: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #chart-wrapper { position: relative; height: 180px; width: 100%; }
        .iowait-warn { color: #f87171; animation: flash 0.8s infinite; }
        @keyframes flash { 50% { opacity: 0.4; } }
    </style>
</head>
<body class="p-4 flex flex-col">
    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4 bg-gray-900/50 p-4 rounded-2xl border border-gray-800">
        <div>
            <span class="text-[10px] text-blue-500 font-black tracking-widest uppercase">Storage Profile</span>
            <div id="mode-status" class="text-sm font-bold text-blue-400">SUPER DISK (RAID 1 Mirror)</div>
        </div>
        <div>
            <span class="text-[10px] text-gray-500 font-bold uppercase">CPU I/O Wait</span>
            <div id="iowait-val" class="text-lg mono font-bold text-white">0.1%</div>
        </div>
        <div>
            <span class="text-[10px] text-gray-500 font-bold uppercase">Latency (p99)</span>
            <div id="lat-val" class="text-lg mono font-bold text-green-400">0.45ms</div>
        </div>
        <div>
            <span class="text-[10px] text-gray-500 font-bold uppercase">Writes/Reads</span>
            <div id="ops-val" class="text-lg mono font-bold text-white">0 / 0</div>
        </div>
        <div class="flex items-center gap-2">
            <button id="auto-btn" class="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded-lg text-[10px] font-black uppercase transition-all">Start Loop</button>
            <button id="mode-btn" class="flex-1 bg-gray-800 hover:bg-gray-700 py-2 rounded-lg text-[10px] font-black uppercase transition-all">Toggle Mode</button>
        </div>
    </div>

    <div class="grid grid-cols-12 gap-4 flex-1 overflow-hidden">
        <div class="col-span-3 flex flex-col gap-4">
            <div class="bg-gray-900/50 border border-gray-800 p-4 rounded-2xl">
                <h3 class="text-[10px] font-bold text-gray-500 uppercase mb-3">Hardware Layer</h3>
                <div class="flex items-center justify-between bg-black p-2 rounded-lg border border-gray-800 mb-2">
                    <span class="text-[10px] mono">SSDs NVMes</span>
                    <div class="flex gap-3">
                        <button id="ssd-minus" class="text-blue-500 font-bold">-</button>
                        <button id="ssd-plus" class="text-blue-500 font-bold">+</button>
                    </div>
                </div>
                <button id="fault-btn" class="w-full py-2 border border-red-900 text-red-500 text-[10px] font-bold rounded-lg hover:bg-red-500/10 uppercase transition-all">Induce NVMe-0 Failure</button>
            </div>

            <div class="bg-gray-900/50 border border-gray-800 p-4 rounded-2xl flex-1 min-h-[220px]">
                <h3 class="text-[10px] font-bold text-gray-400 uppercase mb-4">Storage Performance Trend</h3>
                <div id="chart-wrapper">
                    <canvas id="latencyChart" width="300" height="180"></canvas>
                </div>
            </div>
        </div>

        <div class="col-span-9 bg-gray-950/50 border border-gray-800 rounded-3xl p-6 relative flex flex-col">
            <div class="flex justify-center mb-6">
                <div id="db-node" class="bg-gray-900 border-2 border-blue-500/50 p-4 rounded-xl flex flex-col items-center z-50 shadow-2xl">
                    <i data-lucide="database" class="w-6 h-6 text-blue-500 mb-1"></i>
                    <span class="text-[10px] font-bold uppercase tracking-widest text-white">ScyllaDB Instance</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-8 flex-1 overflow-hidden">
                <div class="flex flex-col">
                    <div class="text-[10px] font-black text-blue-500 mb-4 uppercase flex justify-between">
                        <span>Path A: RAID 0 Local Stripe</span>
                        <span id="path-a-label" class="text-blue-900">ACTIVE</span>
                    </div>
                    <div id="ssd-grid" class="grid grid-cols-2 gap-3 scroll-area pr-2"></div>
                </div>
                <div class="flex flex-col">
                    <div class="text-[10px] font-black text-purple-500 mb-4 uppercase">Path B: Cloud PD Mirror</div>
                    <div id="pd-container" class="bg-gray-900/50 border border-purple-900/20 rounded-xl p-4 flex-1 overflow-hidden">
                        <div id="pd-data" class="scroll-area space-y-1 pr-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.addEventListener('load', () => {
            setTimeout(initApp, 100);
        });

        function initApp() {
            let config = { ssds: 4, isAuto: false, isCorrupt: false, mode: 'super' };
            let metrics = { writes: 0, reads: 0, lat: 0.5, histS: Array(30).fill(null), histT: Array(30).fill(null), labels: Array(30).fill('') };
            let storage = new Map();
            let chart, loop;

            // --- 1. Render SSD Hardware ---
            const renderSSDs = () => {
                const grid = document.getElementById('ssd-grid');
                grid.innerHTML = '';
                for(let i=0; i<config.ssds; i++) {
                    grid.innerHTML += `
                        <div id="ssd-${i}" class="ssd-node rounded-xl p-3 h-28 flex flex-col ${config.isCorrupt && i === 0 ? 'corrupted' : ''}">
                            <div class="raid-tag">NVMe PORT ${i}</div>
                            <div id="data-list-${i}" class="flex-1 overflow-y-auto space-y-1 mt-3 scrollbar-hide"></div>
                        </div>`;
                }
                lucide.createIcons();
            };

            // --- 2. Chart Setup ---
            const ctx = document.getElementById('latencyChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: metrics.labels,
                    datasets: [
                        { label: 'Super Disk', borderColor: '#3b82f6', data: metrics.histS, tension: 0.4, borderWidth: 2, pointRadius: 0 },
                        { label: 'Cloud PD', borderColor: '#a855f7', data: metrics.histT, tension: 0.4, borderWidth: 2, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: 0, max: 4, grid: { color: '#1e293b' }, ticks: { font: { size: 9 }, color: '#64748b' } },
                        x: { display: false }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // --- 3. I/O Logic (70% Writes) ---
            const processIO = async (isWrite) => {
                if (isWrite) metrics.writes++; else metrics.reads++;
                
                const key = `k_${Math.floor(Math.random()*999)}`;
                const val = Math.random().toString(36).substring(7).toUpperCase();
                const stripeIdx = Math.floor(Math.random() * config.ssds);

                if (isWrite) {
                    // Mirroring: Write to both Path A (RAID 0) and Path B (PD)
                    if (config.mode === 'super') animatePacket(key, 'db-node', `ssd-${stripeIdx}`, '#3b82f6');
                    animatePacket(key, 'db-node', 'pd-container', '#a855f7');
                    
                    setTimeout(() => {
                        storage.set(key, {val, stripeIdx});
                        const html = `<div class="text-[8px] mono p-1 bg-black/40 rounded truncate border-l-2 border-blue-500">${key}:${val}</div>`;
                        if (config.mode === 'super') document.getElementById(`data-list-${stripeIdx}`).insertAdjacentHTML('afterbegin', html);
                        document.getElementById('pd-data').insertAdjacentHTML('afterbegin', html.replace('blue', 'purple'));
                    }, 400);
                } else {
                    // Reading: Use Fast Local Path if possible
                    const keys = Array.from(storage.keys());
                    if (keys.length > 0) {
                        const target = keys[Math.floor(Math.random()*keys.length)];
                        const data = storage.get(target);
                        
                        if (config.mode === 'super') {
                            if (config.isCorrupt && data.stripeIdx === 0) {
                                // Fallback to PD on disk failure
                                metrics.lat = 2.4 + Math.random();
                                animatePacket(target, 'db-node', 'pd-container', '#ef4444');
                            } else {
                                // Fast local read
                                metrics.lat = 0.4 + (Math.random()*0.1);
                                animatePacket(target, 'db-node', `ssd-${data.stripeIdx}`, '#22c55e');
                            }
                        } else {
                            // Traditional mode always uses PD
                            metrics.lat = 2.1 + (Math.random()*0.4);
                            animatePacket(target, 'db-node', 'pd-container', '#a855f7');
                        }
                    }
                }
            };

            const animatePacket = (txt, fId, tId, color) => {
                const f = document.getElementById(fId).getBoundingClientRect();
                const t = document.getElementById(tId).getBoundingClientRect();
                const p = document.createElement('div');
                p.className = 'packet mono font-bold';
                p.style.cssText = `background:${color}; color:white; left:${f.left + f.width/2}px; top:${f.top + f.height/2}px;`;
                p.innerText = txt;
                document.body.appendChild(p);
                p.animate([
                    { left: `${f.left + f.width/2}px`, top: `${f.top + f.height/2}px`, opacity: 0 },
                    { opacity: 1, offset: 0.15 },
                    { left: `${t.left + t.width/2}px`, top: `${t.top + t.height/2}px`, opacity: 0 }
                ], { duration: 600, easing: 'ease-out' }).onfinish = () => p.remove();
            };

            // --- 4. Main Event Handlers ---
            document.getElementById('mode-btn').addEventListener('click', () => {
                config.mode = config.mode === 'super' ? 'trad' : 'super';
                const status = document.getElementById('mode-status');
                const pathA = document.getElementById('path-a-label');
                
                if (config.mode === 'super') {
                    status.innerText = 'SUPER DISK (RAID 1 Mirror)';
                    status.className = 'text-sm font-bold text-blue-400';
                    pathA.innerText = 'ACTIVE';
                    pathA.className = 'text-blue-500';
                } else {
                    status.innerText = 'TRADITIONAL (PD Only)';
                    status.className = 'text-sm font-bold text-purple-400';
                    pathA.innerText = 'BYPASSED';
                    pathA.className = 'text-gray-700';
                }
            });

            document.getElementById('auto-btn').addEventListener('click', (e) => {
                config.isAuto = !config.isAuto;
                e.target.innerText = config.isAuto ? 'STOP' : 'START LOOP';
                e.target.classList.toggle('bg-blue-600'); e.target.classList.toggle('bg-red-600');
                if(config.isAuto) loop = setInterval(() => processIO(Math.random() < 0.7), 400); // 70% Write Pressure
                else clearInterval(loop);
            });

            document.getElementById('fault-btn').addEventListener('click', (e) => {
                config.isCorrupt = !config.isCorrupt;
                e.target.innerText = config.isCorrupt ? "REPLACE DISK" : "INDUCE NVME-0 FAILURE";
                renderSSDs();
            });

            document.getElementById('ssd-plus').addEventListener('click', () => { if(config.ssds < 6) { config.ssds++; renderSSDs(); document.getElementById('ssd-count-display').innerText = config.ssds; } });
            document.getElementById('ssd-minus').addEventListener('click', () => { if(config.ssds > 1) { config.ssds--; renderSSDs(); document.getElementById('ssd-count-display').innerText = config.ssds; } });

            // Stats Update
            setInterval(() => {
                const ioWait = (metrics.lat > 1.5) ? (metrics.lat * 14).toFixed(1) : (Math.random() * 0.2).toFixed(1);
                document.getElementById('iowait-val').innerText = `${ioWait}%`;
                document.getElementById('iowait-val').className = ioWait > 10 ? 'text-lg mono font-bold iowait-warn' : 'text-lg mono font-bold text-white';
                document.getElementById('lat-val').innerText = `${metrics.lat.toFixed(2)}ms`;
                document.getElementById('ops-val').innerText = `${metrics.writes} W / ${metrics.reads} R`;
                
                metrics.histS.push(config.mode === 'super' ? metrics.lat : null);
                metrics.histT.push(config.mode === 'trad' ? metrics.lat : null);
                metrics.histS.shift(); metrics.histT.shift();
                chart.update('none');
                metrics.writes = 0; metrics.reads = 0;
            }, 1000);

            renderSSDs();
        }
    </script>
</body>
</html>
