<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raft Consensus: Chaos & Recovery Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: #f8fafc; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .node { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; border-width: 2px; }
        .leader { border-color: #3b82f6 !important; box-shadow: 0 0 25px rgba(59, 130, 246, 0.4); }
        .dead { filter: grayscale(1) opacity(0.2); border-style: dashed !important; border-color: #475569 !important; }
        .recovering { animation: pulse-blue 1s infinite; border-color: #60a5fa !important; }
        @keyframes pulse-blue { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .packet { position: absolute; width: 10px; height: 10px; border-radius: 50%; pointer-events: none; z-index: 100; transition: all 0.6s ease-in; }
        .pk-append { background: #3b82f6; box-shadow: 0 0 8px #3b82f6; }
        .log-entry { font-size: 0.6rem; padding: 2px 4px; margin: 2px 0; border-radius: 4px; border: 1px solid transparent; }
        .committed { background: #065f46; color: #a7f3d0; border-color: #059669; }
        .uncommitted { background: #78350f; color: #fde68a; border-color: #b45309; }
        .progress-bar { height: 4px; background: #1e293b; border-radius: 2px; overflow: hidden; margin-top: 4px; }
        .progress-fill { height: 100%; background: #3b82f6; width: 0%; transition: width 0.1s linear; }
    </style>
</head>
<body class="p-6">
    <div class="max-w-[1400px] mx-auto space-y-6">
        <header class="bg-slate-900 border border-slate-800 p-6 rounded-3xl flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-xl font-black uppercase tracking-tighter">Raft <span class="text-blue-500">Chaos Engine</span></h1>
                <p class="text-slate-500 text-[10px] mono">Quorum: <span id="q-val">3</span>/5 | Term: <span id="t-val">1</span></p>
            </div>
            <div class="flex flex-wrap gap-2">
                <button onclick="triggerWrite()" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-xl text-xs font-bold transition">Client Write</button>
                <button onclick="killLeader()" class="bg-red-950 text-red-400 border border-red-900/50 px-4 py-2 rounded-xl text-xs font-bold hover:bg-red-900 transition">Kill Leader</button>
                <button onclick="killRandom()" class="bg-slate-800 px-4 py-2 rounded-xl text-xs font-bold hover:bg-slate-700 transition">Kill Random Node</button>
                <button onclick="healNode()" class="bg-emerald-950 text-emerald-400 border border-emerald-900/50 px-4 py-2 rounded-xl text-xs font-bold hover:bg-emerald-900 transition">Heal One Node</button>
            </div>
        </header>

        <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-8 space-y-6">
                <div id="net-plane" class="relative h-72 bg-slate-900/40 rounded-[2.5rem] border border-slate-800/50 flex justify-around items-center px-10 overflow-hidden">
                    </div>
                <div class="grid grid-cols-5 gap-3" id="log-viz">
                    </div>
            </div>

            <div class="col-span-12 lg:col-span-4 space-y-6">
                <div class="bg-slate-900 border border-slate-800 p-5 rounded-3xl h-[600px] flex flex-col">
                    <h3 class="text-[10px] font-bold text-slate-500 uppercase mb-4 flex justify-between">
                        <span>Recovery & Consensus Trace</span>
                        <button onclick="document.getElementById('trace').innerHTML=''" class="hover:text-white">Clear</button>
                    </h3>
                    <div id="trace" class="flex-1 overflow-y-auto space-y-2 mono text-[10px] pr-2">
                        <div class="text-slate-600 italic">System initialized. Awaiting commands...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const NODE_COUNT = 5;
        let nodes = [];
        let globalTerm = 1;

        class Node {
            constructor(id) {
                this.id = id;
                this.role = id === 0 ? 'leader' : 'follower';
                this.isAlive = true;
                this.isRecovering = false;
                this.wal = []; // {idx, term, val, committed}
                this.db = 0;
                this.term = 1;
                this.timer = 0;
                this.electionTimeout = Math.random() * 4000 + 4000;
            }
        }

        function init() {
            nodes = Array.from({length: NODE_COUNT}, (_, i) => new Node(i));
            setInterval(tick, 100);
            render();
        }

        function tick() {
            nodes.forEach(n => {
                if (!n.isAlive) return;
                if (n.role !== 'leader') {
                    n.timer += 100;
                    if (n.timer >= n.electionTimeout) startElection(n);
                }
            });
            updateBars();
        }

        function startElection(candidate) {
            const alive = nodes.filter(n => n.isAlive).length;
            if (alive < 3) return; // Cannot win without quorum

            globalTerm++;
            nodes.forEach(n => n.role = 'follower');
            candidate.role = 'leader';
            candidate.term = globalTerm;
            candidate.timer = 0;
            addTrace(`[ELECTION] Node ${candidate.id} became Leader for Term ${globalTerm}`, "text-blue-400");
            render();
        }

        async function triggerWrite() {
            const leader = nodes.find(n => n.role === 'leader' && n.isAlive);
            if (!leader) return addTrace("[FAIL] Write rejected: No Leader", "text-red-500");
            
            const aliveCount = nodes.filter(n => n.isAlive).length;
            if (aliveCount < 3) return addTrace("[SAFETY] Write rejected: No Quorum", "text-red-500");

            const val = Math.floor(Math.random() * 100) + 1;
            const idx = leader.wal.length;
            const entry = { idx, term: leader.term, val, committed: false };
            
            leader.wal.push(entry);
            addTrace(`[WAL] Leader N${leader.id} appended Idx:${idx}. Replicating...`);
            render();

            nodes.forEach(n => {
                if (n.id !== leader.id && n.isAlive) {
                    sendPacket(leader.id, n.id, 'pk-append', () => {
                        n.wal[idx] = {...entry};
                        render();
                        sendPacket(n.id, leader.id, 'pk-append', () => finalizeCommit(idx));
                    });
                }
            });
        }

        function finalizeCommit(idx) {
            const leader = nodes.find(n => n.role === 'leader');
            if (!leader) return;
            const acks = nodes.filter(n => n.isAlive && n.wal[idx] && n.wal[idx].val === leader.wal[idx].val).length;
            
            if (acks >= 3 && !leader.wal[idx].committed) {
                addTrace(`[COMMIT] Quorum reached for Idx:${idx}. Applying to DB.`, "text-emerald-400");
                nodes.forEach(n => {
                    if (n.wal[idx]) {
                        n.wal[idx].committed = true;
                        n.db = n.wal[idx].val;
                    }
                });
                render();
            }
        }

        function killLeader() {
            const l = nodes.find(n => n.role === 'leader');
            if (l) {
                l.isAlive = false;
                addTrace(`[KILL] Leader Node ${l.id} terminated.`, "text-red-500");
                render();
            }
        }

        function killRandom() {
            const alive = nodes.filter(n => n.isAlive);
            if (alive.length === 0) return;
            const target = alive[Math.floor(Math.random() * alive.length)];
            target.isAlive = false;
            addTrace(`[KILL] Node ${target.id} terminated.`, "text-orange-500");
            render();
        }

        async function healNode() {
            const dead = nodes.find(n => !n.isAlive);
            if (!dead) return;

            dead.isAlive = true;
            dead.isRecovering = true;
            dead.timer = 0;
            addTrace(`[HEAL] Node ${dead.id} rebooting. Initiating log sync...`, "text-emerald-400");
            render();

            const leader = nodes.find(n => n.role === 'leader' && n.isAlive);
            if (leader) {
                await new Promise(r => setTimeout(r, 1000));
                // Simulate log reconciliation (Catch-up)
                dead.wal = JSON.parse(JSON.stringify(leader.wal));
                dead.db = leader.db;
                addTrace(`[SYNC] Node ${dead.id} reconciled ${dead.wal.length} entries. DB synced to ${dead.db}.`, "text-blue-300");
            }
            dead.isRecovering = false;
            render();
        }

        function sendPacket(from, to, type, cb) {
            const plane = document.getElementById('net-plane');
            const start = document.getElementById(`node-${from}`).getBoundingClientRect();
            const end = document.getElementById(`node-${to}`).getBoundingClientRect();
            const container = plane.getBoundingClientRect();

            const p = document.createElement('div');
            p.className = `packet ${type}`;
            p.style.left = (start.left - container.left + 35) + 'px';
            p.style.top = (start.top - container.top + 35) + 'px';
            plane.appendChild(p);

            setTimeout(() => {
                p.style.left = (end.left - container.left + 35) + 'px';
                p.style.top = (end.top - container.top + 35) + 'px';
            }, 50);
            setTimeout(() => { p.remove(); if(cb) cb(); }, 650);
        }

        function addTrace(msg, color="text-slate-400") {
            const t = document.getElementById('trace');
            if (t.innerHTML.includes("Waiting")) t.innerHTML = "";
            t.innerHTML = `<div class="py-1 border-b border-slate-800/50 ${color}">[${new Date().toLocaleTimeString().split(' ')[0]}] ${msg}</div>` + t.innerHTML;
        }

        function updateBars() {
            document.getElementById('t-val').innerText = globalTerm;
            nodes.forEach(n => {
                const fill = document.getElementById(`fill-${n.id}`);
                if (fill) {
                    const progress = n.role === 'leader' ? 0 : (n.timer / n.electionTimeout) * 100;
                    fill.style.width = Math.min(progress, 100) + '%';
                }
            });
        }

        function render() {
            const plane = document.getElementById('net-plane');
            const logViz = document.getElementById('log-viz');
            plane.innerHTML = ''; logViz.innerHTML = '';

            nodes.forEach(n => {
                const nEl = document.createElement('div');
                nEl.id = `node-${n.id}`;
                nEl.className = `node w-20 h-20 rounded-3xl bg-slate-800 flex flex-col items-center justify-center border-slate-700 ${!n.isAlive ? 'dead' : n.isRecovering ? 'recovering' : n.role === 'leader' ? 'leader' : ''}`;
                nEl.innerHTML = `
                    <span class="text-[9px] font-bold text-slate-500">N${n.id}</span>
                    <span class="text-2xl">${!n.isAlive ? 'üíÄ' : n.role === 'leader' ? 'üëë' : 'üñ•Ô∏è'}</span>
                    <div class="progress-bar w-12"><div id="fill-${n.id}" class="progress-fill"></div></div>
                `;
                plane.appendChild(nEl);

                const lEl = document.createElement('div');
                lEl.className = "bg-slate-900 border border-slate-800 p-3 rounded-2xl min-h-[180px] shadow-lg";
                lEl.innerHTML = `
                    <div class="text-[10px] font-bold text-blue-400 mb-2 border-b border-slate-800 pb-1 flex justify-between">
                        <span>N${n.id}</span><span class="text-slate-500">DB:${n.db}</span>
                    </div>
                    ${n.wal.map(e => `<div class="log-entry ${e.committed ? 'committed' : 'uncommitted'}">I:${e.idx} T:${e.term} V:${e.val}</div>`).join('')}
                `;
                logViz.appendChild(lEl);
            });
        }

        init();
    </script>
</body>
</html>
